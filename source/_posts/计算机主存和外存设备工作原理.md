---
title: 计算机的存储单元（1）
toc: true
recommend: 1
uniqueId: 2024-04-28 05:04:53/计算机的存储单元（1）.html
mathJax: false
date: 2024-04-28 13:04:53
thumbnail: https://cdn.jsdelivr.net/gh/gh503/CDN@1.0.0/img/bookcase-3614450_1920.png
tags:
    - '存储单元'
    - '内存'
    - '硬盘'
    - 'SSD'
    - 'U盘'
categories:
    - '计算机'
keywords:
    - '编码'
    - '存储单元'
    - '编址'
    - '寻址'
    - '大小端'
---
> 摘要
计算机存储单元的组成，存储空间计算、编址与寻址、数据读写。
<!-- more -->
## 引言
计算机知识可能显得太枯燥，也不容易理解。很多时候，想一想为什么这么设计，了解背后的故事，知识也变得深刻。计算机历史充满着趣味性和智慧，

## 计算机存储
这篇仅讨论内存（主存）和外存设备。

### 存储单元
我们知道计算机使用电子元器件电压范围来判断是高是低，或使用磁化物质是否被磁化记录信息，而这些信息也就是我们说的“1”和“0”。一个元器件表示2种状态，计算机定义为一个`bit`有“1”和“0”两种取值。

计算机中规定`8bits`为`1byte`。字节`byte`的[历史定义](https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82)，指能够用于编码单个字符所需要的`bit`数量。

那为什么不是`7bits`或者`9bits`呢？历史上确实出现了非`8bits`的定义标准，不同的计算机标准，`1byte不一定等于8bits`。但最终都被筛选淘汰掉了。[为什么计算机的一个存储单元是八位？](https://www.zhihu.com/question/20870588/answer/27391534)，现如今我们认为`1byte=8bits`。

也就是说，我们`1byte`就足以表示单个字符。

### 存储空间计算
假设1个存储单元就是`1byte`，可以表示`2^8 = 256`种状态，表示256个字符。

`1 KiloBytes  = 2^10 Bytes`，1千字节
`1 MillBytes  = 2^20 Bytes`，1兆字节
`1 GigaBytes  = 2^30 Bytes`，1吉字节
`1 TeraBytes  = 2^40 Bytes`，1钛字节
`1 PetaBytes  = 2^50 Bytes`，1拍字节
`1 ExaBytes   = 2^60 Bytes`，1艾字节
`1 ZettaBytes = 2^70 Bytes`，1泽字节
`1 YottaBytes = 2^80 Bytes`，1尧字节

这里1个`Byte`意味着8个电子元器件，不考虑电路其他元件的话。

### 典型存储单元大小
通常主存设备也就以`1byte`来作为最小的存储单元。

实际产品中，存储单元的大小由产品硬件设计决定。
如果定义存储单元大小为`512Bytes`，即使是32位-4字节的地址总线，也能支持`2^32*512Bytes=2TB`存储空间。比如机械磁盘的寻址单元（最小存储单元）,称之为扇区，就是`512Bytes`。

常见外设存储设备的存储单元大小：
- 机械磁盘：`512Bytes`，扇区作为最小存储单元。

- `SSD`固态磁盘：`SSD`的最小存储单元是`1page`，是由一组颗粒组成。每个颗粒（`cell`）可以是`1bit`、`2bits`、`3bits`甚至`4bits`，典型的`1page`是`4KB`，常提及的`4KB`对齐就是这么来的，也即最小存储单元是`4KB`。`NTFS`默认最小分配单元正好`4KB`，或者使用`4KB`的任何整数倍。需要说的是`SSD`在擦除数据的时候，不是以`page`为单位，而是以多个`page`组成的块（`Block`）为单位。

- U盘：闪存的一种，一般使用建议的最小存储单元，通常是`4KB`。而且U盘不建议使用`NTFS`格式文件系统（“日志式”，需要记录详细的读写操作），因为要不断读写比较伤闪存芯片。一般用`FAT32`或`exFAT`（支持`>4GB`的单个文件操作）。

### 编码
`CPU`中输入数据（转换后的电平信号）经过设计好的电路实现逻辑和算术运算，运算结果输出到电子元器件电压状态或者组合电子元器件的电压状态（电平信号）。保持这个元件的状态后，然后可以将这些结果数据固化到磁盘、SSD、U盘等外存设备。

输入和输出数据在计算机看来都是电平信号，它是怎么和我们的字符、文字相对应起来的呢？

这里就用到了一种映射的概念，计算机称之为编码。读者应该查找编码相关资料文档，进行了解。这里推荐一篇文章，可以帮助我们系统性地理解编码：[字符编码的前世今生——一文读懂字符编码](https://cloud.tencent.com/developer/article/1450938)。

- 我们键盘输入字符，在保存的时候，操作系统会以用户指定或者默认的编码方式查对应编码表将字符编码成二进制数据，并写入存储器保存。
- 输出的结果数据，或者打开保存的文本时，操作系统根据编码方式，查找对应的编码表将二进制数据解码，然后绘制显示在屏幕上。

如果没有指明文件编码，操作系统编辑默认行为存在差异，比如在`Windows`系统上默认地区编码（中国-`GBK`，page 936）读写文件，`Linux`系统（UTF8）或其他系统打开，可能出现乱码。`GBK`以2个字节编码汉字，`UTF8`以3个字节编码汉字，因此相同内容不同编码占用大小是不一样的。但是`UTF8`是国际统一编码，更不容易乱码。`UTF-8 with BOM`在文档头插入了`0xEF 0xBB 0xBF`的`Unicode`字节顺序标记。如果使用`UTF8`编码，一定要使用`without BOM`的标准编码方式。

[unicode.org](https://home.unicode.org/)

需要说的是，我们看到的文字、数字、字符、图片、视频，听到的音频等，在计算机看来都是数字信号，通过编码的方式存入存储设备，通过解码的方式转换为我们看到的或听到的。解码后让我们能看到需要计算机发送数据给屏幕进行绘制，让我们听到需要发送数据给音频设备播放。

## 编址与寻址
读写存储设备的前提是能准确定位指定的位置，更确切地说，颗粒度定位到某个指定的存储单元。

### 主存设备

利用编码的思想，我们可以设计一个电路或者功能结构，其功能是只要输入位置编码信息（某种表示状态）就可以唯一确定对应的存储单元。
- 1个`bit`有2种组合，可以唯一确定2个存储单元
- 2个`bit`有4种组合，可以唯一确定4个存储单元
- N个`bit`有2^N种组合，可以唯一确定`2^N`个存储单元

假设输入有32个电子元器件，那么有`2^32`种组合，也就是`4G`个存储单元的空间。
当增加到64个时，可寻址存储单元个数`2^64`，即`2^32 * 4G = 16E`。

地址总线：`Address Bus`，可以认为是在`CPU`访问主存时，提供了这样的一个电路。
如果地址总线宽度为32，则能够唯一确定`4G`个存储单元，也即`4GB`，宽度64，则不需要担心主存空间瓶颈的问题。

想象将所有存储单元一字排开，开始给他们依次编号。有了编号就可以找到对应的存储单元。根据我们地址总线的宽度，可以从0开始编号，直到将所有存储单元都完成编号或者超过支持的最大存储空间。这样，当我们在地址总线输入端设置对应的编号数据（对应电平信号）时，电路直接能唯一确定到对应的存储单元。`CPU`根据命令，经由数据总线读写数据。通常数据总线和地址总线宽度相同，但不绝对。

总之，`CPU`访问主存时，`地址总线宽度N`决定了所支持的主存空间大小（`2^N`个存储单元）。

### 机械硬盘 HDD
也叫磁盘，因为机械硬盘使用的是磁性物质来记录信息。

如果不了解机械硬盘，可以阅读[机械硬盘的工作原理](https://www.dbsos.cn/blog/260.html)。

![](https://cdn.jsdelivr.net/gh/gh503/CDN@1.0.0/img/girl-583917_1920.jpg)

机械硬盘由两种寻址方式：
- CHS寻址
使用柱面号（`cylinder`，`10bits`）、磁头号（`head`，`8bits`）、扇区号（`sector`，`6bits`）唯一确定存储某一位置的数据。通过机械的方式获取磁性盘片上的数据。

不考虑机械设计约束，最大寻址空间：`2^cylinder_bits * 2^head_bits * 2^sector_bits * sector_size_bytes /1024/1024/1024 GB`

- LBA寻址
将三维寻址方式转换成一维寻址方式，定义`LBA逻辑扇区号`：
`磁头数 * 每隧道扇区数 * 当前所在柱面号 + 每隧道扇区数 * 当前所在磁头号 + 当前所在扇区号 - 1`

通过硬盘控制器，将逻辑地址转换为实际硬盘的物理地址。

最大寻址扇区数：2^ 地址位数-1。

在硬盘或U盘等设备格式化时，可以设定存储单元大小，可以预料到最小存储单元越小，利用率越高，效率越低；而最小存储单元越大，利用率越低，效率反而越高。申请过内存的同学肯定知道，内存空间足够的话，我就不需要再申请了，而且可以一次性写入和读取。

### 固态硬盘 SSD
我们都知道固态硬盘速度比机械硬盘快多了，而且没有机械硬盘的噪音，体型小带来的易携带、也不怕振动带来的数据损坏。因为固态硬盘使用的时光学寻址，没有磁头、盘片这些精密部件。而且没有存储单元都有唯一的地址，因此在访问存储单元的时候，都是直接使用唯一直接访问。

### 字 word
字的定义，表示自然的数据单位。在计算机中，表示一次性处理事务的固定长度位组。这个很好理解，计算机处理数据就像人类语言表达一样，我们也使用文字或单词（`word`）来表达。

字不是固定长度，由计算机`CPU`中数据总线宽度决定。如果数据总线宽度`32bits`，字长`32bits`；如果数据总线宽度`64bits`，则字长`64bits`。而`字节长度`在不同的计算机中，我们认为都是`8bits`。存储单元可以是字、字节，两者没有必然联系。可以根据实际情况进行换算。

### 数据读写
#### 数据的高低字节
1个字节=`8bits`，高低2个字节=`16bits`，用16进制形式表达为`0xABCD`。
我们知道16进制1位需要`4bits`来表达`0~15`。也就是2位16进制需要`8bits`，1个字节。

这里`AB`为高字节，`CD`字节（10进制1234中，12高位，34低位）。

#### 地址的高低
我们已经按存储单元给存储空间进行编号，每个存储单元都有自己的地址。从0到`2^N-1`，这里`N`为地址总线的宽度。
如果将地址换算成16进制的话，就是`0x0`到`0x3FFFFFFFFFFFF（N=32）`。

低地址：从0开始，前面的地址
高地址：从0开始，后面的地址，最后的地址最高。两者相对的。

存储单元如果从前往后使用，称之为往高地址方向生长。反之，称之为往低地址方向生长。

#### 存数据

当我们拿到数据时，该怎么存呢？
是优先用高地址还是地地址？
如果一份数据需要用到2个或者多个存储单元时，应该把高字节放到高地址还是低地址？

确实有不同的方案。

- 数据： `0xABCD`
- 存储单元：`0x1234`

第一种方法：我们将数据从左往右存入存储单元中，有点类似字符串顺序处理。称之为“大端模式（`Big-endian`）”。即：
`0xAB` -> `0x12`
`0xCD` -> `0x34`

第二种方法：将小的数据放入低地址，将大的数据放入高地址，这种处理方法和我们的逻辑一致。称之为“小端模式（`Little-endian`）”。即：
`0xAB` -> `0x34`
`0xCD` -> `0x12`

#### 取数据

当我们取数据的时候，读出来的字节应该怎么恢复为原始数据？
- 存储单元：`0x1234`
- 存储数据：`0xABCD`

如果是大端模式：由于是按字符串方式存的，所以取的时候也一样，直接还原为`0xABCD`
如果是小端模式：由于是按大小高低逻辑方式存的，所以低字节的数据在低位，还原为`0xCDAB`。不是`0xDCBA`（半字节）或`0xABCD`（双字节），因为这里例子存储单元是按字节操作的。

那计算机到底是哪种模式，可以使用程序测试：
1.创建占用2个存储单元的数据并赋值，当然两个存储单元的数值肯定要不同，然后逐个读取
2.如果低位是高字节，是大端；如果低位是低字节，是小端。


参考文章:
无。
